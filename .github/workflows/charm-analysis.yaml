name: Charm Analysis

on:
  workflow_dispatch:

jobs:
  integration:
    name: Integration Test (build and deploy)
    runs-on: charm-runner-1
    
    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Connect to Tailscale
      uses: tailscale/github-action@v3
      with:
        oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
        oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
        tags: tag:ci

    - name: Get Tailscale IP
      id: tailscale-ip
      run: |
        TAILSCALE_IP=$(tailscale ip -4)
        echo "ip=$TAILSCALE_IP" >> $GITHUB_OUTPUT
        echo "üåê Runner accessible at: $TAILSCALE_IP"

    - name: Setup SSH Debug (Tailscale Direct)
      uses: lexbritvin/ssh-session-action@v1
      with:
        # No jump host needed - direct connection via Tailscale
        ssh-server-host: ${{ steps.tailscale-ip.outputs.ip }}
        ssh-server-port: 2223
        use-actor-ssh-keys: true

#    - name: Set up Charmcraft and pack the charm
#      uses: canonical/craft-actions/charmcraft/pack@main
#      with: 
#        channel: "3.x/stable"
#        verbosity: brief
        
    - name: Install concierge
      run: sudo snap install --classic concierge

    - name: Install juju and bootstrap
      run: |
        sudo concierge -v prepare \
            --juju-channel=2.9/stable \
            --charmcraft-channel=3.x/stable \
            --preset machine
    
    - name: Install dependencies
      run: python -m pip install tox

    - name: Run integration tests
      run: tox -vve func
      
