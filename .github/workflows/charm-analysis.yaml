name: Charm Analysis

on:
  workflow_dispatch:

jobs:
  integration:
    name: Integration Test (build and deploy)
    runs-on: charm-runner-1
    
    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Set up Charmcraft and pack the charm
      uses: ./.github/workflows/build-and-test.yaml
              
    - name: Install concierge
      run: sudo snap install --classic concierge

    - name: Install juju and bootstrap
      run: |
        sudo concierge -v prepare \
            --juju-channel=2.9/stable \
            --charmcraft-channel=3.x/stable \
            --preset machine
    
    - name: Install dependencies
      run: python -m pip install tox

    - name: Run integration tests
      run: tox -vve func
      
